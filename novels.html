<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ميديكال شوب — متجر المستلزمات الطبية (نسخة مُحسّنة)</title>
<meta name="description" content="متجر مستلزمات طبية — نسخة مُحسّنة: قائمة جانبية مغلقة افتراضياً، سلة محلية، وضع ليلي، فلترة/بحث سلس، لا رجفة." />
<link rel="icon" href="images/logo.png" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<!-- Lottie -->
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

<style>
/* ========================
   VARIABLES & RESET
   ======================== */
:root{
  --main: #1abc9c;
  --accent: #0b8f73;
  --muted: #6b7280;
  --bg: #f6f7f9;
  --card: #ffffff;
  --text: #0f1724;
  --radius: 12px;
  --overlay: rgba(0,0,0,0.0);
  --currency: د.ب;
  --transition-fast: 180ms;
  --transition-mid: 280ms;
}
body.dark{
  --bg: #0f1724;
  --card: #121316;
  --text: #e6eef0;
  --muted: #a8b3b6;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
a{color:inherit;text-decoration:none}
button{font-family:inherit;cursor:pointer}

/* ========================
   NAVBAR
   ======================== */
.navbar{
  position:sticky; top:0; z-index:1200;
  display:flex; gap:12px; align-items:center;
  padding:10px 16px; background:linear-gradient(90deg,var(--main),var(--accent)); color:white;
  box-shadow:0 6px 18px rgba(2,6,23,0.08);
}
.logo{display:flex;align-items:center;gap:12px}
.logo img{width:44px;height:44px;object-fit:cover;border-radius:8px;background:#fff;padding:4px}
.search-box{flex:1;display:flex;gap:10px;background:rgba(255,255,255,0.12);padding:8px 12px;border-radius:10px;align-items:center}
.search-box input{border:0;background:transparent;color:inherit;outline:none;font-size:15px;width:100%}
.icons{display:flex;gap:8px;align-items:center}
.icon-btn{background:transparent;border:0;color:inherit;font-size:18px;padding:8px;border-radius:8px}

/* ========================
   LAYOUT
   ======================== */
.container{
  display:grid;
  grid-template-columns: 280px 1fr;
  gap:20px; padding:22px; max-width:1200px; margin:0 auto;
}
@media(max-width:920px){ .container{ grid-template-columns: 1fr; padding:12px } }

/* ========================
   SIDEBAR (مخفية افتراضياً)
   ======================== */
/* مهم: نخفيها عبر transform لتفادي reflow => لا رجفة */
.sidebar{
  background:var(--card); border-radius:12px; padding:16px; box-shadow:0 8px 30px rgba(2,6,23,0.06);
  height:calc(100vh - 88px); overflow:auto;
  position:relative;
  /* hidden by default using transform */
  transform: translateX(0); /* على الشاشات الكبيرة تبقى ظاهرة */
  transition: transform var(--transition-mid) ease, opacity var(--transition-fast) ease;
}
/* mobile overlay: sidebar مخفية خارج الشاشة */
.sidebar.mobile-hidden { transform: translateX(110%); opacity:0; pointer-events:none; position:fixed; top:0; right:0; height:100vh; z-index:1600; width:280px; }
.sidebar.mobile-open  { transform: translateX(0); opacity:1; pointer-events:auto; }

/* backdrop عند فتح القائمة على الموبايل */
.mobile-backdrop{ display:none; position:fixed; inset:0; background:var(--overlay); z-index:1500; opacity:0; transition:opacity var(--transition-fast) ease; }
.mobile-backdrop{
  display:block; /* اجعلها دائمًا block */
  opacity:0;
  pointer-events:none;
  transition:opacity var(--transition-fast) ease;
}
.mobile-backdrop.visible{
  opacity:1;
  pointer-events:auto;
}

/* الفئات */
.cat-list a{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin-bottom:8px;transition:background 120ms}
.cat-list a.active{background:rgba(0,0,0,0.04)}
.small{font-size:13px;color:var(--muted)}

/* ========================
   MAIN SHOP
   ======================== */
.top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap}
.shop-title{font-size:20px;font-weight:700}
.filters{display:flex;gap:8px;align-items:center}
.filters select, .filters button{padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent}

/* ==================================
   PRODUCT GRID & CARDS (no layout shift)
   ================================== */
/* Important: use aspect-ratio to reserve image space (prevents CLS) */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px}
.card{
  background:var(--card); border-radius:12px; overflow:hidden; display:flex; flex-direction:column;
  box-shadow:0 6px 20px rgba(2,6,23,0.06); position:relative; transition:transform var(--transition-fast) ease, box-shadow var(--transition-fast);
  will-change: transform;
}
.card:hover{ transform:translateY(-6px); box-shadow:0 12px 36px rgba(2,6,23,0.12) }
.card .img-wrap{ width:100%; aspect-ratio: 4 / 3; overflow:hidden; background:linear-gradient(180deg,#efefef,#fff) }
.card img{ width:100%; height:100%; object-fit:cover; display:block; transition:filter var(--transition-fast); }

/* body.dark images slight brightness change without layout changes */
body.dark .card img{ filter:brightness(.9) }

.card-body{ padding:12px; display:flex; flex-direction:column; gap:8px; min-height:120px }
.card h4{ margin:0; font-size:15px; font-weight:600; text-align:right }
.desc{ margin:0; font-size:13px; color:var(--muted); display:block; line-height:1.2; height:2.4em; overflow:hidden; text-overflow:ellipsis }

.price-row{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:auto }
.price{ font-weight:700; font-size:16px }
.btn-buy{ background:var(--main); color:white; border:none; padding:8px 10px; border-radius:8px }

/* badge (lottie or fallback) */
.sale-badge{ position:absolute; top:8px; left:8px; width:64px; height:64px; z-index:3; pointer-events:none }

/* ========================
   CART FAB & MODAL
   ======================== */
.cart-fab{ position:fixed; left:20px; bottom:20px; z-index:1400; background:var(--main); color:white; padding:12px; border-radius:12px; display:flex; gap:10px; align-items:center; box-shadow:0 10px 30px rgba(15,23,36,0.18) }
.cart-count{ background:rgba(255,255,255,0.12); padding:6px 8px; border-radius:8px; font-weight:700 }

.modal-backdrop{ position:fixed; inset:0; background:var(--overlay); display:none; align-items:center; justify-content:center; z-index:1500 }
.modal{ width:100%; max-width:720px; background:var(--card); border-radius:12px; padding:16px; box-shadow:0 20px 60px rgba(2,6,23,0.4) }
.cart-list{ max-height:380px; overflow:auto; display:flex; flex-direction:column; gap:10px; margin:12px 0 }
.cart-item{ display:flex; gap:10px; align-items:center; border-radius:8px; padding:8px; background:rgba(0,0,0,0.03) }
.cart-item img{ width:64px; height:64px; object-fit:cover; border-radius:8px }

/* empty */
.empty{ text-align:center; padding:40px 20px; color:var(--muted) }

/* accessibility focus */
.card:focus-within, .cat-list a:focus { outline:2px solid rgba(26,188,156,0.22) }

@media(max-width:600px){ .card .img-wrap{ aspect-ratio: 3/2 } .card img{ height:100% } }

</style>
</head>
<body>

<noscript>
  <div style="background:#ffdede;padding:10px;text-align:center">جافاسكربت معطّل — الصفحة تحتاج JS لتعمل بالكامل.</div>
</noscript>

<!-- NAV -->
<header class="navbar" role="navigation" aria-label="شريط التنقل الرئيسي">
  <div class="logo">
    <img src="images/logo.png" alt="شعار" onerror="this.src='images/placeholder.jpg'">
    <div style="display:flex;flex-direction:column;line-height:1">
      <strong>ميديكال شوب</strong>
      <span class="small">مستلزمات طبية موثوقة</span>
    </div>
  </div>

  <div class="search-box" role="search" aria-label="بحث المنتجات">
    <input id="searchInput" type="search" placeholder="ابحث عن منتج، فئة أو وصف..." aria-label="حقل البحث" />
    <i class="fa fa-search" aria-hidden="true"></i>
  </div>

  <div class="icons">
    <button id="themeToggle" class="icon-btn" aria-label="تبديل الوضع">
      <lottie-player id="moonAnim" src="animations/moon.json" background="transparent" speed="1" style="width:28px;height:28px;display:block" loop autoplay></lottie-player>
      <lottie-player id="sunAnim" src="animations/sun.json" background="transparent" speed="1" style="width:28px;height:28px;display:none" loop autoplay></lottie-player>
    </button>

    <!-- زر القائمة للهواتف -->
    <button id="mobileMenuBtn" class="icon-btn" aria-controls="sidebar" aria-expanded="false" title="القائمة" style="display:none">☰</button>
  </div>
</header>

<!-- MOBILE BACKDROP FOR SIDEBAR -->
<div id="mobileBackdrop" class="mobile-backdrop" tabindex="-1" aria-hidden="true"></div>

<main class="container" role="main">
  <!-- SIDEBAR -->
  <aside id="sidebar" class="sidebar" aria-label="قائمة التصنيفات">
    <h3>التصنيفات</h3>
    <nav class="cat-list" aria-label="فئات المنتجات">
      <!-- سيتم ملؤها ديناميكياً -->
    </nav>

    <hr style="margin:14px 0; opacity:0.08" />

    <div>
      <h3 style="margin-bottom:8px">تصفية حسب السعر</h3>
      <div style="display:flex; gap:8px; align-items:center">
        <input id="minPrice" type="number" placeholder="من" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)" />
        <input id="maxPrice" type="number" placeholder="إلى" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)" />
      </div>
      <button id="applyPrice" style="margin-top:8px;width:100%;padding:10px;border-radius:8px;border:none;background:var(--main);color:white;cursor:pointer">تطبيق</button>
    </div>
  </aside>

  <!-- MAIN SHOP -->
  <section aria-label="قائمة المنتجات" style="min-height:400px">
    <div class="top-bar">
      <div class="shop-title"><i class="fa fa-bag-medical"></i> متجر المستلزمات الطبية</div>
      <div class="filters">
        <select id="sortSelect" aria-label="ترتيب">
          <option value="popular">الأكثر مبيعًا</option>
          <option value="price-asc">الأرخص</option>
          <option value="price-desc">الأغلى</option>
          <option value="new">الأحدث</option>
        </select>
        <button id="clearFilters">مسح الفلاتر</button>
      </div>
    </div>

    <div class="grid" id="productsGrid" aria-live="polite" aria-atomic="true">
      <!-- تُولد ديناميكياً -->
    </div>
  </section>
</main>

<!-- CART FAB -->
<div class="cart-fab" id="cartFab" role="button" aria-label="عرض السلة" tabindex="0">
  <i class="fa fa-shopping-cart"></i>
  <div>سلة التسوق</div>
  <div class="cart-count" id="cartCount">0</div>
</div>

<!-- CART MODAL -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document" aria-labelledby="cartTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 id="cartTitle">سلة التسوق</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <strong id="cartTotal">0</strong>
        <button id="closeModal" class="icon-btn" aria-label="إغلاق">×</button>
      </div>
    </div>

    <div class="cart-list" id="cartList"></div>

    <div style="display:flex;justify-content:space-between;gap:10px;margin-top:12px;align-items:center">
      <div><div class="small">محاكاة الدفع — لا يوجد باك-إند</div></div>
      <div style="display:flex;gap:8px">
        <button id="emptyCart" style="padding:10px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent">تفريغ السلة</button>
        <button id="checkoutBtn" style="padding:10px 12px;border-radius:8px;background:var(--main);color:white;border:none">إتمام الطلب</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
   CONFIG + DATA (تعديل سهل)
   =========================== */
const CURRENCY = 'د.ب';           // العملة للعرض
const CART_KEY = 'medical_shop_cart_final_v1';

// منتجات افتراضية — عدّل، أضف أو اربط بباك-إند لاحقاً
const PRODUCTS = [
  { id:'p1', title:'معطف طبي قابل للغسل (أزرق)', desc:'قماش مضاد للبقع، عدة مقاسات، مناسب للعيادات.', price:18.5, category:'clothing', img:'images/coat-blue.jpg', stock:50, badge:'', createdAt:'2025-01-10' },
  { id:'p2', title:'جهاز قياس ضغط الدم الرقمي', desc:'شاشة رقمية مع حفظ قياسات.', price:34.0, category:'measurement', img:'images/bp-monitor.jpg', stock:25, badge:'new', createdAt:'2025-04-12' },
  { id:'p3', title:'قناع طبي ثلاثي الطبقات (50 قطعة)', desc:'قناع حماية مطابق للمواصفات.', price:9.99, category:'sterile', img:'images/masks.jpg', stock:200, badge:'', createdAt:'2024-11-04' },
  { id:'p4', title:'معقم يدين 500 مل (جل)', desc:'معقم كحولي بتركيز 70% — سريع ومرطب.', price:6.75, category:'sterile', img:'images/hand-sanitizer.jpg', stock:120, badge:'', createdAt:'2025-02-01' },
  { id:'p5', title:'مقعد طبي محمول للعيادات', desc:'قابل للطي، خفيف، سهل التنظيف.', price:48.0, category:'clinic', img:'images/clinic-chair.jpg', stock:8, badge:'sale', createdAt:'2024-09-20' },
  { id:'p6', title:'حقيبة أدوات طبية احترافية', desc:'حافظ واسع وجيوب متعددة.', price:29.9, category:'accessories', img:'images/medical-bag.jpg', stock:34, badge:'', createdAt:'2025-03-05' }
];

/* ===========================
   HELPERS (صغيرة ومفيدة)
   =========================== */
const $ = (s, ctx=document) => ctx.querySelector(s);
const $$ = (s, ctx=document) => Array.from(ctx.querySelectorAll(s));
function fmtCurrency(n){
  try { return new Intl.NumberFormat('ar-EG', { style:'currency', currency:'BHD' }).format(n).replace('BHD', CURRENCY); }
  catch(e){ return n + ' ' + CURRENCY; }
}
function escapeHtml(t){ return (t+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[c])); }
function debounce(fn, wait=200){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); }; }

/* ===========================
   CART (localStorage)
   =========================== */
let cart = {};
function loadCart(){ try { cart = JSON.parse(localStorage.getItem(CART_KEY)) || {}; } catch(e){ cart = {}; } }
function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); renderCartCount(); }
function addToCart(id, qty=1){
  const p = PRODUCTS.find(x=>x.id===id); if(!p) return alert('المنتج غير موجود');
  const current = cart[id] || 0;
  if(current + qty > p.stock) return alert('الكمية المطلوبة تتجاوز المخزون المتاح.');
  cart[id] = current + qty; saveCart(); animateCartFab();
}
function setQty(id, qty){
  const p = PRODUCTS.find(x=>x.id===id); if(!p) return;
  if(qty <= 0){ removeFromCart(id); return; }
  if(qty > p.stock) return alert('الكمية المطلوبة تتجاوز المخزون');
  cart[id] = qty; saveCart(); renderCartModal();
}
function removeFromCart(id){ delete cart[id]; saveCart(); renderCartModal(); }
function emptyCart(){ if(confirm('هل تريد تفريغ السلة؟')){ cart = {}; saveCart(); renderCartModal(); } }

/* ===========================
   RENDER PRODUCTS (efficient)
   =========================== */
const productsGrid = $('#productsGrid');
const searchInput = $('#searchInput');
const sortSelect = $('#sortSelect');

function renderProducts(list = PRODUCTS){
  productsGrid.innerHTML = '';
  const frag = document.createDocumentFragment();

  // build DOM in fragment (faster)
  list.forEach(p => {
    const art = document.createElement('article');
    art.className = 'card product-card';
    art.tabIndex = 0;
    art.dataset.id = p.id;

    // use img wrap with aspect-ratio to prevent layout shift
    art.innerHTML = `
      <div class="img-wrap">
        ${p.badge ? `<div class="sale-badge" data-badge="${p.badge}"></div>` : ''}
        <img src="${p.img}" alt="${escapeHtml(p.title)}" loading="lazy" onerror="this.src='images/placeholder.jpg'">
      </div>
      <div class="card-body">
        <h4>${escapeHtml(p.title)}</h4>
        <p class="desc">${escapeHtml(p.desc)}</p>
        <div class="price-row">
          <div>
            <div class="price">${fmtCurrency(p.price)}</div>
            <div class="small">المخزون: ${p.stock}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-start">
            <button class="btn-buy" data-id="${p.id}"><i class="fa fa-cart-plus"></i> أضف للسلة</button>
            <a href="#" class="small quick-buy" data-id="${p.id}">شراء سريع</a>
          </div>
        </div>
      </div>
    `;

    frag.appendChild(art);
  });

  productsGrid.appendChild(frag);

  // attach badges Lottie safely
  $$('.sale-badge').forEach(el=>{
    const badge = el.dataset.badge;
    const anim = document.createElement('lottie-player');
    anim.setAttribute('src', `animations/${badge}.json`);
    anim.setAttribute('background','transparent');
    anim.setAttribute('speed','1');
    anim.style.width='64px'; anim.style.height='64px';
    anim.setAttribute('loop',''); anim.setAttribute('autoplay','');
    // bare try: if file missing, lottie throws internal error but doesn't break JS
    el.appendChild(anim);
  });
}

/* ===========================
   FILTER / SEARCH / SORT
   Debounced search to avoid jank
   =========================== */
function applyFilters(){
  const qv = (searchInput.value || '').trim().toLowerCase();
  const activeCat = $('.cat-list a.active')?.dataset.filter || 'all';
  const minP = Number($('#minPrice').value || 0);
  const maxP = Number($('#maxPrice').value || Infinity);

  let res = PRODUCTS.filter(p=>{
    const matchesQuery = !qv || (p.title + ' ' + p.desc).toLowerCase().includes(qv);
    const matchesCat = (activeCat === 'all') || (p.category === activeCat);
    const matchesPrice = (p.price >= minP) && (p.price <= maxP);
    return matchesQuery && matchesCat && matchesPrice;
  });

  const sort = sortSelect.value;
  if(sort === 'price-asc') res.sort((a,b)=>a.price - b.price);
  else if(sort === 'price-desc') res.sort((a,b)=>b.price - a.price);
  else if(sort === 'new') res.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));

  renderProducts(res);
}
const debouncedApply = debounce(applyFilters, 180);

/* ===========================
   BUILD CATEGORIES (dynamic + safe ordering)
   =========================== */
function buildCategories(){
  const container = $('.cat-list');
  const cats = { all: { count: PRODUCTS.length } };
  PRODUCTS.forEach(p => { cats[p.category] = cats[p.category] || { count:0 }; cats[p.category].count++; });

  const order = ['all','clothing','measurement','sterile','clinic','accessories'];
  container.innerHTML = '';
  order.forEach(k=>{
    if(!cats[k]) return;
    const a = document.createElement('a');
    a.href='#';
    a.dataset.filter = k;
    a.className = k === 'all' ? 'active' : '';
    a.innerHTML = `${translateCategory(k)} <span class="small">(${cats[k].count})</span>`;
    a.addEventListener('click', e=>{
      e.preventDefault();
      $$('.cat-list a').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
      applyFilters();
      // عند اختيار فئة على الموبايل، أغلق الشريط لتجربة مستخدم أفضل
      if(window.innerWidth < 920) closeMobileSidebar();
    });
    container.appendChild(a);
  });
}
function translateCategory(k){
  return ({ all:'الكل', clothing:'الملابس الطبية', measurement:'أجهزة القياس', sterile:'أدوات التعقيم', clinic:'مستلزمات العيادات', accessories:'إكسسوارات طبية' }[k] || k);
}

/* ===========================
   CART UI (modal rendering)
   =========================== */
const cartFab = $('#cartFab');
const cartCountEl = $('#cartCount');
const modalBackdrop = $('#modalBackdrop');
const cartList = $('#cartList');
const cartTotalEl = $('#cartTotal');

function renderCartCount(){
  const total = Object.values(cart).reduce((s,n)=>s+n,0);
  cartCountEl.textContent = total;
}

function renderCartModal(){
  cartList.innerHTML = '';
  const keys = Object.keys(cart);
  if(keys.length === 0){
    cartList.innerHTML = '<div class="empty">سلة الشراء فارغة</div>';
    cartTotalEl.textContent = fmtCurrency(0);
    renderCartCount();
    return;
  }
  let total = 0;
  keys.forEach(id=>{
    const qty = cart[id];
    const p = PRODUCTS.find(x=>x.id===id);
    if(!p) return;
    const div = document.createElement('div');
    div.className = 'cart-item';
    div.innerHTML = `
      <img src="${p.img}" alt="${escapeHtml(p.title)}" onerror="this.src='images/placeholder.jpg'">
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${escapeHtml(p.title)}</strong><div class="small">${escapeHtml(p.desc)}</div></div>
          <div class="small">${fmtCurrency(p.price)}</div>
        </div>
        <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:8px;align-items:center">
            <button class="icon-btn qty-minus" data-id="${id}">−</button>
            <div class="small" style="min-width:32px;text-align:center">${qty}</div>
            <button class="icon-btn qty-plus" data-id="${id}">+</button>
          </div>
          <button class="icon-btn remove-item" data-id="${id}" title="إزالة"><i class="fa fa-trash"></i></button>
        </div>
      </div>
    `;
    cartList.appendChild(div);
    total += p.price * qty;
  });

  // ربط الأزرار بعد بناء DOM
  $$('.qty-plus').forEach(b => b.addEventListener('click', ()=> setQty(b.dataset.id, (cart[b.dataset.id]||0) + 1)));
  $$('.qty-minus').forEach(b => b.addEventListener('click', ()=> setQty(b.dataset.id, (cart[b.dataset.id]||0) - 1)));
  $$('.remove-item').forEach(b => b.addEventListener('click', ()=> removeFromCart(b.dataset.id)));

  cartTotalEl.textContent = fmtCurrency(total);
  renderCartCount();
}

function openModal(){ renderCartModal(); modalBackdrop.style.display = 'flex'; modalBackdrop.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden'; }
function closeModal(){ modalBackdrop.style.display = 'none'; modalBackdrop.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; }

cartFab.addEventListener('click', openModal);
cartFab.addEventListener('keydown', e=> { if(e.key === 'Enter') openModal(); });
$('#closeModal').addEventListener('click', closeModal);
modalBackdrop.addEventListener('click', e => { if(e.target === modalBackdrop) closeModal(); });
$('#emptyCart').addEventListener('click', emptyCart);
$('#checkoutBtn').addEventListener('click', ()=> {
  if(Object.keys(cart).length === 0){ alert('سلتك فارغة'); return; }
  alert('تم إرسال طلبك (محاكاة).'); cart = {}; saveCart(); closeModal();
});

function animateCartFab(){
  try{ cartFab.animate([{ transform:'scale(1)' }, { transform:'scale(1.06)' }, { transform:'scale(1)' }], { duration:220 }); }
  catch(e){ /* fallback silent */ }
}

/* ===========================
   EVENTS: product actions (delegation)
   =========================== */
productsGrid.addEventListener('click', e=>{
  const buy = e.target.closest('.btn-buy');
  if(buy){ addToCart(buy.dataset.id, 1); return; }
  const quick = e.target.closest('.quick-buy');
  if(quick){ addToCart(quick.dataset.id, 1); openModal(); e.preventDefault(); return; }
});

/* keyboard accessibility: Enter on card adds to cart */
productsGrid.addEventListener('keydown', e=>{
  if(e.key === 'Enter'){
    const card = e.target.closest('.product-card');
    if(card){ addToCart(card.dataset.id,1); }
  }
});

/* ===========================
   THEME (dark/light)
   =========================== */
const themeToggle = $('#themeToggle');
const moonAnim = $('#moonAnim'), sunAnim = $('#sunAnim');
function setTheme(isDark){
  document.body.classList.toggle('dark', !!isDark);
  if(moonAnim) moonAnim.style.display = isDark ? 'none' : 'block';
  if(sunAnim) sunAnim.style.display = isDark ? 'block' : 'none';
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
}
themeToggle.addEventListener('click', ()=> setTheme(!document.body.classList.contains('dark')));
if(localStorage.getItem('theme') === 'dark') setTheme(true);

/* ===========================
   MOBILE SIDEBAR: open/close on click, close on outside click
   Avoid flicker: use transform + backdrop
   =========================== */
const mobileMenuBtn = $('#mobileMenuBtn');
const mobileBackdrop = $('#mobileBackdrop');
const sidebar = $('#sidebar');

function openMobileSidebar(){
  sidebar.classList.remove('mobile-hidden'); sidebar.classList.add('mobile-open');
  mobileBackdrop.classList.add('visible'); mobileBackdrop.setAttribute('aria-hidden','false');
  mobileMenuBtn.setAttribute('aria-expanded','true');
  // prevent body scroll under overlay
  document.body.style.overflow = 'hidden';
}
function closeMobileSidebar(){
  sidebar.classList.remove('mobile-open'); sidebar.classList.add('mobile-hidden');
  mobileBackdrop.classList.remove('visible'); mobileBackdrop.setAttribute('aria-hidden','true');
  mobileMenuBtn.setAttribute('aria-expanded','false');
  document.body.style.overflow = '';
}
mobileMenuBtn.addEventListener('click', ()=> {
  const open = mobileMenuBtn.getAttribute('aria-expanded') === 'true';
  if(open) closeMobileSidebar(); else openMobileSidebar();
});
mobileBackdrop.addEventListener('click', closeMobileSidebar);

/* ensure we only show mobile button on small screens */
function updateMobileUI(){ if(window.innerWidth < 920){ mobileMenuBtn.style.display = 'inline-flex'; sidebar.classList.add('mobile-hidden'); } else { mobileMenuBtn.style.display = 'none'; sidebar.classList.remove('mobile-hidden'); sidebar.classList.remove('mobile-open'); mobileBackdrop.classList.remove('visible'); document.body.style.overflow = ''; } }
window.addEventListener('resize', updateMobileUI);

/* Click outside on desktop to close any open floating sidebar (only applies if you add overlay behavior) */
/* (we keep sidebar visible on desktop by default — no auto-close) */

/* ===========================
   INIT
   =========================== */
document.addEventListener('DOMContentLoaded', ()=>{
  // load cart & init UI
  loadCart();
  buildCategories();
  renderProducts(PRODUCTS);
  renderCartCount();
  updateMobileUI();

  // events
  searchInput.addEventListener('input', debouncedApply);
  sortSelect.addEventListener('change', applyFilters);
  $('#applyPrice').addEventListener('click', applyFilters);
  $('#clearFilters').addEventListener('click', ()=>{
    searchInput.value=''; $('#minPrice').value=''; $('#maxPrice').value='';
    $$('.cat-list a').forEach(a=>a.classList.remove('active')); $('.cat-list a[data-filter="all"]').classList.add('active');
    applyFilters();
  });

  // fallback for images not found
  $$('img').forEach(img => img.addEventListener('error', ()=> img.src = 'images/placeholder.jpg'));
});

/* ===========================
   FINAL NOTES (safety & logs)
   =========================== */
// clear dev console to avoid confusion when testing
if(window.console && console.clear) console.clear();

</script>
</body>
        </html>
